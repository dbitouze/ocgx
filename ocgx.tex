% La syntaxe est:

%   \OCG{<nom>}{<texte>}
%   \OCG*{<nom>}{<texte>}

% crée un OCG nommé <nom> (pour référence, et pour le panneau des calques
% dans Acrobat) recouvrant <texte>. Dans la version sans étoile, <texte>
% est visible par défaut, avec étoile il est invisible.

%   \switchOCG{<liste de noms>}{<texte>}

% transforme <texte> en zone cliquable qui rend (in)visibles les OCG
% nommés dans <liste de noms>, lesquels noms sont séparés par des espaces.
% La commande peut très bien apparaître avant les \OCG correspondants.
% Attention, <texte> est mis dans une \hbox; il peut être nécessaire
% d'utiliser \quitvmode.

%   \finishOCG

% À ajouter en fin de fichier si le code est utilisé avec plain TeX. Avec
% LaTeX, pas besoin, c'est fait tout seul.

% En revanche, je ne suis pas sûr qu'il n'y ait pas conflit avec TikZ, en
% particulier si on utilise des dégradés.

% Au passage, j'ai découvert qu'en effet Evince gère les OCG ... sauf
% qu'il n'y a pas de panneaux de calques...

% Paul


\ifdefined\newcommand
  % LaTeX
  \def\ocgx@page{\thepage}
  \def\ocgx@error{\PackageError{newocg}}
  \RequirePackage{ifpdf}
\else
  % TeX
  \def\ocgx@page{\the\pageno}
  \def\ocgx@error#1{\errmessage{Package newocg error: #1}}
  \input ifpdf.sty
\fi


% testing for PDF mode
\unless\ifpdf
   \ocgx@error{*TeX is not running in PDF mode}%
\fi

% testing for correct pdfTeX version
\ifnum\pdftexversion<120
   \ocgx@error{pdfeTeX, version >= 1.20, required}
\fi

\def\ocgx@store#1#2{%
  \unless\ifcsname ocgx@page:#2\endcsname
    \expandafter\def\csname ocgx@page:#2\endcsname{}%
  \fi
  \expandafter\edef\csname ocgx@page:#2\endcsname{\csname ocgx@page:#2\endcsname#1}%
}

\newread\ocgx@read
\openin\ocgx@read=\jobname.ocg
\unless\ifeof\ocgx@read
  \input \jobname.ocg
\fi
\closein\ocgx@read

\newwrite\ocgx@write
\immediate\openout\ocgx@write=\jobname.ocg
\def\ocgx@writeocg#1{%
  \edef\ocgx@temp{\noexpand\noexpand\noexpand\ocgx@store{#1}}%
  \write\ocgx@write\expandafter{\ocgx@temp{\ocgx@page}}%
  }

\def\ocgx@spacecs{ }

\def\ocgx@list{}
\def\ocgx@addocg#1{%
  \xdef\ocgx@list{\ocgx@list #1 }%
  }
\def\ocgx@OFFlist{}
\def\ocgx@addOFFocg#1{%
  \ocgx@addocg{#1}%
  \xdef\ocgx@OFFlist{\ocgx@OFFlist #1 }%
  }

\def\ocgx@lastobj{\the\pdflastobj\ocgx@spacecs}%

\long\def\ocgx@OCG#1#2#3{%
  \ifcsname ocgx@OCG_#2\endcsname
    \def\ocgx@objspec{useobjnum \csname ocgx@OCG_#2\endcsname}%
  \else
    \def\ocgx@objspec{}%
  \fi
  \immediate\pdfobj\ocgx@objspec{%
    << /Type/OCG
       /Name (#2) >> }%
  \expandafter\xdef\csname ocgx@OCG_#2\endcsname{\ocgx@lastobj}%
  \ocgx@writeocg{/group\ocgx@lastobj \ocgx@lastobj 0 R }%
  #1{\ocgx@lastobj 0 R}%
  \pdfliteral direct {/OC/group\ocgx@lastobj BDC }%
  #3%
  \pdfliteral direct {EMC}%
  }

\long\def\switchOCG#1#2{%
  \def\ocgx@list{}%
  \ocgx@listOCG#1 ENDOFOCGS %
  \hbox{%
    \pdfannot{%
      /Subtype /Link
      /A << /S/SetOCGState /State [/Toggle \ocgx@list] >>
      /Border [0 0 0]
    }%
    #2}%
  }

\long\def\showOCG#1#2{%
  \def\ocgx@list{}%
  \ocgx@listOCG#1 ENDOFOCGS %
  \hbox{%
    \pdfannot{%
    /Subtype/Link
    /A << /S/SetOCGState
          /State [/ON \ocgx@list] >>
          /Border [0 0 0]
        }%
    #2}%
  }

\long\def\hideOCG#1#2{%
  \def\ocgx@list{}%
  \ocgx@listOCG#1 ENDOFOCGS %
  \hbox{%
    \pdfannot{%
    /Subtype/Link
    /A << /S/SetOCGState
          /State [/OFF \ocgx@list] >>
          /Border [0 0 0]
        }%
    #2}%
  }

\long\def\actionsOCG#1#2#3#4{
  \def\ocgx@list{}%
  \ocgx@listOCG#1 ENDOFOCGS %
  \edef\ocgx@toswitch{\ocgx@list}
  %
  \def\ocgx@list{}%
  \ocgx@listOCG#1 ENDOFOCGS %
  \edef\ocgx@toshow{\ocgx@list}
  %
  \def\ocgx@list{}%
  \ocgx@listOCG#1 ENDOFOCGS %
  \edef\ocgx@tohide{\ocgx@list}
  %
  \hbox{%
    \pdfannot{%
    /Subtype/Link
    /A << /S/SetOCGState
          /State [/Toggle \ocgx@toswitch /ON \ocgx@toshow /OFF \ocgx@tohide] >>
          /Border [0 0 0]
        }%
    #4%
  }%
}


\csname ocgx@end:ENDOFOCGS\endcsname
\def\ocgx@listOCG#1 {%
  \unless\ifcsname ocgx@end:#1\endcsname
    \ifcsname ocgx@OCG_#1\endcsname
      \expandafter\def\expandafter\ocgx@list\expandafter{%
        \ocgx@list
        \csname ocgx@OCG_#1\endcsname 0 R }%
    \fi%
    \expandafter\ocgx@listOCG
  \fi
}

\def\ocgx@afterfi#1#2\fi{\fi#1}
\csname ocgx@star:*\endcsname
\def\OCG#1{%
  \ifcsname ocgx@star:#1\endcsname
    \ocgx@afterfi{\ocgx@OCG\ocgx@addOFFocg}%
  \else
    \ocgx@afterfi{\ocgx@OCG\ocgx@addocg{#1}}%
  \fi
}

\def\ocgx@setpageresources{%
  \ifcsname ocgx@page:\thepage\endcsname
  \edef\ocgx@temp{\pdfpageresources{\the\pdfpageresources\ocgx@spacecs
      /Properties <<\csname ocgx@page:\ocgx@page\endcsname>>}}%  
  \ocgx@temp
  \fi
}

\def\finishOCG{%
  \pdfcatalog {/OCProperties << /OCGs [\ocgx@list]
    /D << /Order [\ocgx@list]
    /BaseState/ON
    /OFF [\ocgx@OFFlist] >> >>}%
}

\output\expandafter{%
  \expandafter\ocgx@setpageresources
  \the\output
}

\unless\ifx\AtEndDocument\HopefullyThisIsUndefined
  \AtEndDocument{\finishOCG}
\fi
