% La syntaxe est:

%   \OCG{<nom>}{<texte>}
%   \OCG*{<nom>}{<texte>}

% crée un OCG nommé <nom> (pour référence, et pour le panneau des calques
% dans Acrobat) recouvrant <texte>. Dans la version sans étoile, <texte>
% est visible par défaut, avec étoile il est invisible.

%   \switchOCG{<liste de noms>}{<texte>}

% transforme <texte> en zone cliquable qui rend (in)visibles les OCG
% nommés dans <liste de noms>, lesquels noms sont séparés par des espaces.
% La commande peut très bien apparaître avant les \OCG correspondants.
% Attention, <texte> est mis dans une \hbox; il peut être nécessaire
% d'utiliser \quitvmode.

%   \finishOCG

% À ajouter en fin de fichier si le code est utilisé avec plain TeX. Avec
% LaTeX, pas besoin, c'est fait tout seul.

% En revanche, je ne suis pas sûr qu'il n'y ait pas conflit avec TikZ, en
% particulier si on utilise des dégradés.

% Au passage, j'ai découvert qu'en effet Evince gère les OCG ... sauf
% qu'il n'y a pas de panneaux de calques...

% Paul


\ifdefined\newcommand
  \def\ocg@error{\PackageError{newocg}}
  \RequirePackage{ifpdf}
\else
  \def\ocg@error#1{\errmessage{Package newocg error: #1}}
  \input ifpdf.sty
\fi


% testing for PDF mode
\unless\ifpdf
   \ocg@error{*TeX is not running in PDF mode}%
\fi

% testing for correct pdfTeX version
\ifnum\pdftexversion<120
   \ocg@error{pdfeTeX, version >= 1.20, required}
\fi

\def\ocg@store#1#2{%
  \unless\ifcsname ocg@page:#2\endcsname
    \expandafter\def\csname ocg@page:#2\endcsname{}%
  \fi
  \expandafter\edef\csname ocg@page:#2\endcsname{\csname ocg@page:#2\endcsname#1}%
  }

\newread\ocg@read
\openin\ocg@read=\jobname.ocg
\unless\ifeof\ocg@read
  \input \jobname.ocg
\fi
\closein\ocg@read

\newwrite\ocg@write
\immediate\openout\ocg@write=\jobname.ocg
\def\ocg@writeocg#1{%
  \edef\ocg@temp{\noexpand\noexpand\noexpand\ocg@store{#1}}%
  \write\ocg@write\expandafter{\ocg@temp{\thepage}}%
  }

\def\ocg@spacecs{ }

\def\ocg@list{}
\def\ocg@addocg#1{%
  \xdef\ocg@list{\ocg@list #1 }%
  }
\def\ocg@OFFlist{}
\def\ocg@addOFFocg#1{%
  \ocg@addocg{#1}%
  \xdef\ocg@OFFlist{\ocg@OFFlist #1 }%
  }

\def\ocg@lastobj{\the\pdflastobj\ocg@spacecs}%

\long\def\ocg@OCG#1#2#3{%
  \ifcsname ocg@OCG_#2\endcsname
    \def\ocg@objspec{useobjnum \csname ocg@OCG_#2\endcsname}%
  \else
    \def\ocg@objspec{}%
  \fi
  \immediate\pdfobj\ocg@objspec{%
    << /Type/OCG
       /Name (#2) >> }%
  \expandafter\xdef\csname ocg@OCG_#2\endcsname{\ocg@lastobj}%
  \ocg@writeocg{/group\ocg@lastobj \ocg@lastobj 0 R }%
  #1{\ocg@lastobj 0 R}%
  \pdfliteral direct {/OC/group\ocg@lastobj BDC }%
  #3%
  \pdfliteral direct {EMC}%
  }

\long\def\switchOCG#1#2{%
  \def\ocg@toswitch{}%
  \ocg@switchOCG#1 ENDOFOCGS %
  \hbox{%
    \pdfannot{%
      /Subtype /Link
      /A << /S/SetOCGState /State [/Toggle \ocg@toswitch] >>
      /Border [0 0 0]
    }%
    #2}%
  }

\long\def\showOCG#1#2{%
  \def\ocg@toshow{}%
  \ocg@showOCG#1 ENDOFOCGS %
  \hbox{%
    \pdfannot{%
    /Subtype/Link
    /A << /S/SetOCGState
          /State [/ON \ocg@toshow] >>
          /Border [0 0 0]
        }%
    #2}%
  }

\long\def\hideOCG#1#2{%
  \def\ocg@tohide{}%
  \ocg@hideOCG#1 ENDOFOCGS %
  \hbox{%
    \pdfannot{%
    /Subtype/Link
    /A << /S/SetOCGState
          /State [/OFF \ocg@tohide] >>
          /Border [0 0 0]
        }%
    #2}%
  }

\long\def\actionsOCG#1#2#3#4{
  \def\ocg@toswitch{}%
  \def\ocg@toshow{}%
  \def\ocg@tohide{}%
  \ocg@switchOCG#1 ENDOFOCGS %
  \ocg@showOCG#2 ENDOFOCGS %
  \ocg@hideOCG#3 ENDOFOCGS %
  \hbox{%
    \pdfannot{%
    /Subtype/Link
    /A << /S/SetOCGState
          /State [/Toggle \ocg@toswitch /ON \ocg@toshow /OFF \ocg@tohide] >>
          /Border [0 0 0]
        }%
    #4%
  }%
}


\csname ocg@end:ENDOFOCGS\endcsname
\def\ocg@switchOCG#1 {%
  \unless\ifcsname ocg@end:#1\endcsname
    \ifcsname ocg@OCG_#1\endcsname
      \expandafter\def\expandafter\ocg@toswitch\expandafter{%
        \ocg@toswitch
        \csname ocg@OCG_#1\endcsname 0 R }%
    \fi%
    \expandafter\ocg@switchOCG
  \fi
}

\def\ocg@showOCG#1 {%
  \unless\ifcsname ocg@end:#1\endcsname
    \ifcsname ocg@OCG_#1\endcsname
      \expandafter\def\expandafter\ocg@toshow\expandafter{%
        \ocg@toshow
        \csname ocg@OCG_#1\endcsname 0 R }%
    \fi%
    \expandafter\ocg@showOCG
  \fi
}

\def\ocg@hideOCG#1 {%
  \unless\ifcsname ocg@end:#1\endcsname
    \ifcsname ocg@OCG_#1\endcsname
      \expandafter\def\expandafter\ocg@tohide\expandafter{%
        \ocg@tohide
        \csname ocg@OCG_#1\endcsname 0 R }%
    \fi%
    \expandafter\ocg@hideOCG
  \fi
}

\def\ocg@afterfi#1#2\fi{\fi#1}
\csname ocg@star:*\endcsname
\def\OCG#1{%
  \ifcsname ocg@star:#1\endcsname
    \ocg@afterfi{\ocg@OCG\ocg@addOFFocg}%
  \else
    \ocg@afterfi{\ocg@OCG\ocg@addocg{#1}}%
  \fi
}

\def\ocg@setpageresources{%
  \ifcsname ocg@page:\thepage\endcsname
  \edef\ocg@temp{\pdfpageresources{\the\pdfpageresources\ocg@spacecs
      /Properties <<\csname ocg@page:\thepage\endcsname>>}}%  
  \ocg@temp
  \fi
}

\def\finishOCG{%
  \pdfcatalog {/OCProperties << /OCGs [\ocg@list]
    /D << /Order [\ocg@list]
    /BaseState/ON
    /OFF [\ocg@OFFlist] >> >>}%
}

\output\expandafter{%
  \expandafter\ocg@setpageresources
  \the\output
}

\unless\ifx\AtEndDocument\HopefullyThisIsUndefined
  \AtEndDocument{\finishOCG}
\fi
